<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro com Imagem</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="main.css" />
  <style>
    .preview-container img {
      margin-bottom: 10px;
      margin-top: 10px;
    }

    li.card-pessoa {
      border: 1px solid #ccc;
      padding: 0px 0px 10px 0px;
      margin-bottom: 10px;
      list-style: none;
      border-radius: 20px 20px 0px 0px;
    }

    .votacao {
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: rgba(0, 0, 0, 0.07) 0px 1px 2px, rgba(0, 0, 0, 0.07) 0px 2px 4px,
        rgba(0, 0, 0, 0.07) 0px 4px 8px, rgba(0, 0, 0, 0.07) 0px 8px 16px,
        rgba(0, 0, 0, 0.07) 0px 16px 32px, rgba(0, 0, 0, 0.07) 0px 32px 64px;
    }

    .votacao .score {
      min-width: 24px;
      text-align: center;
      font-weight: bold;
    }

    /* Botão de like com animação */
    .like-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
    }

    .like-btn .material-symbols-outlined {
      font-size: 24px;
      color: #888;
      transition: color .2s ease-in-out, transform .2s ease-in-out;
      transform-origin: center center;
    }

    .like-btn.liked .material-symbols-outlined {
      color: #e0245e;
      transform: scale(1.3);
    }

    /* Botão de status substituindo checkbox */
    .status-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
      font-family: "Segoe UI", sans-serif;
      margin-right: 10px;
    }

    .status-btn {
      appearance: none;
      background-color: #fff3e0;
      color: #e65100;
      border: 2px solid #e65100;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      user-select: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
    }

    .status-btn:hover {
      background-color: #ffe0b2;
    }

    .status-btn:focus {
      box-shadow: 0 0 0 3px rgba(230, 81, 0, 0.2);
    }

    .status-btn.resolved {
      background-color: #c8e6c9;
      color: #2e7d32;
      border-color: #2e7d32;
    }

    .status-text {
      font-size: 14px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 5px;
      background-color: #ffebee;
      color: #c62828;
      transition: all 0.3s ease-in-out;
    }

    .status-checkbox-resolved {
      background-color: #e8f5e9;
      color: #2e7d32;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease-in-out;
    }

    .status-checkbox {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid #ff9800;
      border-radius: 4px;
      background-color: #d1cece;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease-in-out;
    }

    .status-checkbox::before {
      content: "";
      position: absolute;
      width: 10px;
      height: 5px;
      border-left: 2px solid #fff;
      border-bottom: 2px solid #fff;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -60%) rotate(-45deg);
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }

    .status-checkbox:checked {
      background-color: #4caf50;
      border-color: #4caf50;
    }

    .status-checkbox:checked::before {
      opacity: 1;
    }

    input:focus,
    textarea:focus {
      outline: none;
    }
  </style>
</head>

<body>
  <header>
    <a href="index.html">
      <span class="material-symbols-outlined" style="font-size: 35px;">exit_to_app</span>
    </a>
    <div class="botao-troca">
      <span class="material-symbols-outlined">routine</span>
      <button class="toggle-mode" id="toggleModoBtn" aria-pressed="false">
        <span class="toggle-handle"></span>
      </button>
    </div>
  </header>

  <div class="position-monitor-flex">
    <div class="container">
      <h2>Divulgar Um Problema</h2>
      <form id="formPessoa" enctype="multipart/form-data">
        <div class="field-group">
          <input type="text" name="nome" id="inputNome" placeholder="Nome" required />
          <button type="button" class="btn-anonimo" id="btnAnonimo">Anônimo?</button>
        </div>
        <input type="text" name="relato" id="inputRelato" placeholder="Relato" required />
        <input type="text" name="localizacao" id="inputLocalizacao" placeholder="Referencia do local" required />
        <label class="custom-file-upload">
          <input type="file" name="imagem" accept="image/*" id="inputImagem" required />
          <i class="fas fa-upload"></i> Escolher imagem
        </label>
        <button type="button" class="camera-btn" id="btnAbrirCamera">
          Tirar foto com a câmera
          <img width="24" height="24" src="https://img.icons8.com/sf-regular-filled/48/add-camera.png" alt="camera" />
        </button>
        <div class="preview-container" id="previewContainer" style="display: none;">
          <img id="previewImagem" alt="Preview da imagem" />
          <button type="button" class="btn-remover" id="btnRemoverImagem">
            <span class="material-symbols-outlined">delete</span> Remover imagem
          </button>
        </div>
        <button type="submit" class="btn-submit">Publicar</button>
      </form>
    </div>
    <div id="cameraPopup" class="camera-popup" style="display: none;" aria-hidden="true">
      <div class="camera-content">
        <div>
          <button type="button" class="close-popup" id="btnFecharCamera">✖</button>
        </div>
        <video id="cameraVideo" autoplay playsinline></video>
        <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: center;">
          <button type="button" class="camera-btn" id="btnTrocarCamera">Trocar Câmera</button>
          <button type="button" class="camera-btn" id="btnCapturarFoto">Capturar</button>
        </div>
      </div>
    </div>
    <div class="container-relato">
      <h2>Relatos Registrados</h2>
      <ul id="listaPessoas"></ul>
    </div>
  </div>

  <script>
    const toggleModoBtn = document.getElementById("toggleModoBtn");
    if (localStorage.getItem("modoEscuro") === "true") {
      document.body.classList.add("dark-mode");
      toggleModoBtn.classList.add("active");
      toggleModoBtn.setAttribute("aria-pressed", "true");
    }
    toggleModoBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      toggleModoBtn.classList.toggle("active", isDark);
      toggleModoBtn.setAttribute("aria-pressed", isDark);
      localStorage.setItem("modoEscuro", isDark);
    });

    const form = document.getElementById("formPessoa");
    const lista = document.getElementById("listaPessoas");
    const inputNome = document.getElementById("inputNome");
    const btnAnonimo = document.getElementById("btnAnonimo");
    const inputRelato = document.getElementById("inputRelato");
    const inputLocalizacao = document.getElementById("inputLocalizacao");
    const inputImagem = document.getElementById("inputImagem");
    const previewContainer = document.getElementById("previewContainer");
    const previewImagem = document.getElementById("previewImagem");
    const btnRemoverImagem = document.getElementById("btnRemoverImagem");

    btnAnonimo.addEventListener("click", () => {
      if (!inputNome.readOnly) {
        inputNome.value = "Anônimo";
        inputNome.readOnly = true;
        btnAnonimo.textContent = "Desfazer";
      } else {
        inputNome.value = "";
        inputNome.readOnly = false;
        btnAnonimo.textContent = "Anônimo?";
      }
    });

    inputImagem.addEventListener("change", () => {
      const file = inputImagem.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          previewImagem.src = e.target.result;
          previewContainer.style.display = "flex";
        };
        reader.readAsDataURL(file);
      }
    });

    btnRemoverImagem.addEventListener("click", () => {
      inputImagem.value = "";
      previewContainer.style.display = "none";
    });

    form.addEventListener("submit", e => {
      e.preventDefault();
      const file = inputImagem.files[0];
      if (!file) return alert("Selecione ou capture uma imagem.");
      const reader = new FileReader();
      reader.onload = ev => salvarRelato(ev.target.result);
      reader.readAsDataURL(file);
    });

    function salvarRelato(imgData) {
      const pessoas = JSON.parse(localStorage.getItem("pessoas_relato") || '[]');
      const id = Date.now();
      pessoas.push({
        id,
        nome: inputNome.value || "Anônimo",
        relato: inputRelato.value,
        localizacao: inputLocalizacao.value,
        imagem: imgData,
        pontos: 0,
        criado_em: new Date().toISOString()
      });
      localStorage.setItem("pessoas_relato", JSON.stringify(pessoas));
      form.reset();
      previewContainer.style.display = "none";
      carregarPessoas();
    }

    function carregarPessoas() {
      const pessoas = JSON.parse(localStorage.getItem("pessoas_relato") || '[]')
        .sort((a, b) => b.pontos - a.pontos);
      const liked = JSON.parse(localStorage.getItem("liked_posts") || '[]');
      lista.innerHTML = "";

      pessoas.forEach(p => {
        const isLiked = liked.includes(p.id);
        const li = document.createElement("li");
        li.className = "card-pessoa";
        li.innerHTML = `
          <div class="votacao">
            <button class="like-btn ${isLiked ? 'liked' : ''}" data-id="${p.id}">
              <span class="material-symbols-outlined">${isLiked ? 'favorite' : 'favorite_border'}</span>
            </button>
            <span class="score">${p.pontos}</span>
            <div class="status-container">
              <input type="checkbox" class="status-checkbox" id="status_${p.id}" data-id="${p.id}" />
              <span class="status-text" id="status_text_${p.id}">em análise</span>
            </div>
          </div>
          <strong>Usuário: ${p.nome}</strong>
          <img src="${p.imagem}" alt="Imagem de ${p.nome}" />
          <p>${p.relato}</p>
          <p><em>${new Date(p.criado_em).toLocaleString('pt-BR')}</em></p>
        `;
        lista.appendChild(li);
      });

      document.querySelectorAll(".like-btn").forEach(btn => {
        btn.onclick = () => {
          const id = Number(btn.dataset.id);
          const span = btn.querySelector("span");
          // Aplica o transform na hora do clique:
          btn.classList.toggle("liked");
          // Atualiza dados e pontuação:
          let posts = JSON.parse(localStorage.getItem("pessoas_relato") || '[]');
          let likes = JSON.parse(localStorage.getItem("liked_posts") || '[]');
          const idx = likes.indexOf(id);
          const pi = posts.findIndex(x => x.id === id);
          if (idx > -1) {
            likes.splice(idx, 1);
            posts[pi].pontos = Math.max(0, posts[pi].pontos - 1);
          } else {
            likes.push(id);
            posts[pi].pontos++;
          }
          localStorage.setItem("pessoas_relato", JSON.stringify(posts));
          localStorage.setItem("liked_posts", JSON.stringify(likes));
          // Atualiza número na interface:
          btn.nextElementSibling.textContent = posts[pi].pontos;
        };
      });

      document.querySelectorAll(".status-checkbox").forEach(cb => {
        cb.onchange = e => {
          const id = cb.dataset.id;
          const txt = document.getElementById(`status_text_${id}`);
          if (cb.checked) {
            txt.textContent = 'resolvido!';
            txt.classList.add('status-checkbox-resolved');
          } else {
            txt.textContent = 'em análise';
            txt.classList.remove('status-checkbox-resolved');
          }
        };
      });
    }

    window.addEventListener("DOMContentLoaded", carregarPessoas);
  </script>
</body>

</html>